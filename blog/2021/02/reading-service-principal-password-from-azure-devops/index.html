<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=/main.eb667497b79ade53c9573b8eb92001a16b3c0c48d1277c5b30ab24325fd2179007333ae02c61ec3ce0a52e89484ed2ada5abeccc973a8d395883482013216753.css integrity="sha512-62Z0l7ea3lPJVzuOuSABoWs8DEjRJ3xbMKskMl/SF5AHMzrgLGHsPOClLolITtKtpavszJc6jTlYg0ggEyFnUw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Reading service principal password from Azure DevOps - Salim KAYABASI</title><meta name=description content="Empowering team members to archive collaborative goals. Always aiming for team success. Experienced on engineering and a great team player with a demonstrated history of working in the transportation/ride hailing/car-sharing industry."><link rel=canonical href=/blog/2021/02/reading-service-principal-password-from-azure-devops/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/doks.png"><meta name=twitter:title content="Reading service principal password from Azure DevOps"><meta name=twitter:description content="Security Given service principal is eligible to manage your services and deployments. Almost all the CI/CD services are coming with masking feature by default for these kinds of secret values.
By design of these CI agents, they are stateless and each build they need sort of environment variable to work as your service principal. This comes with a lot of flexibility where you can extend your setup without caring about previous state."><meta name=twitter:site content="@salimkayabasi"><meta name=twitter:creator content="@salimkayabasi"><meta property="og:title" content="Reading service principal password from Azure DevOps"><meta property="og:description" content="Security Given service principal is eligible to manage your services and deployments. Almost all the CI/CD services are coming with masking feature by default for these kinds of secret values.
By design of these CI agents, they are stateless and each build they need sort of environment variable to work as your service principal. This comes with a lot of flexibility where you can extend your setup without caring about previous state."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2021/02/reading-service-principal-password-from-azure-devops/"><meta property="og:image" content="/doks.png"><meta property="article:published_time" content="2021-02-19T08:15:00+00:00"><meta property="article:modified_time" content="2021-02-19T08:15:00+00:00"><meta property="og:site_name" content="Salim KAYABASI"><meta property="article:publisher" content="https://www.facebook.com/"><meta property="article:author" content="https://www.facebook.com/"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"\/blog\/2021\/02\/reading-service-principal-password-from-azure-devops\/"},"headline":"Reading service principal password from Azure DevOps","image":[],"datePublished":"2021-02-19T08:15:00CET","dateModified":"2021-02-19T08:15:00CET","author":{"@type":"Person","name":"Salim KAYABASI"},"publisher":{"@type":"Person","name":"Salim KAYABASI"},"description":""}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"\/"},{"@type":"ListItem","position":2,"name":"Blog202102reading Service Principal Password From Azure Devops","item":"\/blog202102reading-service-principal-password-from-azure-devops\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon-precomposed sizes=57x57 href=/favicons/apple-touch-icon-57x57.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/favicons/apple-touch-icon-114x114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=/favicons/apple-touch-icon-72x72.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=/favicons/apple-touch-icon-144x144.png><link rel=apple-touch-icon-precomposed sizes=60x60 href=/favicons/apple-touch-icon-60x60.png><link rel=apple-touch-icon-precomposed sizes=120x120 href=/favicons/apple-touch-icon-120x120.png><link rel=apple-touch-icon-precomposed sizes=76x76 href=/favicons/apple-touch-icon-76x76.png><link rel=apple-touch-icon-precomposed sizes=152x152 href=/favicons/apple-touch-icon-152x152.png><link rel=icon type=image/png href=/favicons/favicon-196x196.png sizes=196x196><link rel=icon type=image/png href=/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-128.png sizes=128x128><meta name=application-name content="&nbsp;"><meta name=msapplication-TileColor content="#FFFFFF"><meta name=msapplication-TileImage content="/favicons/mstile-144x144.png"><meta name=msapplication-square70x70logo content="/favicons/mstile-70x70.png"><meta name=msapplication-square150x150logo content="/favicons/mstile-150x150.png"><meta name=msapplication-wide310x150logo content="/favicons/mstile-310x150.png"><meta name=msapplication-square310x310logo content="/favicons/mstile-310x310.png"><link rel=manifest href=/site.webmanifest></head><body class="blog single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 mr-auto" href=/>SK</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link target=_blank href=https://github.com/salimkayabasi><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ml-2 sr-only">GitHub</span></a></li><li class=nav-item><a class=nav-link target=_blank href=https://twitter.com/salimkayabasi><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><span class="ml-2 sr-only">Twitter</span></a></li><li class=nav-item><a class=nav-link target=_blank href=https://www.linkedin.com/in/salimkayabasi><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg><span class="ml-2 sr-only">Linkedin</span></a></li><li class=nav-item><a class=nav-link target=_blank href=https://www.youtube.com/user/salimkayabasi><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-youtube"><path d="M22.54 6.42a2.78 2.78.0 00-1.94-2C18.88 4 12 4 12 4s-6.88.0-8.6.46a2.78 2.78.0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78.0 003.4 19c1.72.46 8.6.46 8.6.46s6.88.0 8.6-.46a2.78 2.78.0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.33z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg><span class="ml-2 sr-only">Youtube</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class="nav-item active"><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/projects/>Projects</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search in blog posts" aria-label=Search... autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><div class=col-12><article><div class=blog-header><h1>Reading service principal password from Azure DevOps</h1><p><small>Posted February 19, 2021 &nbsp;&dash;&nbsp;<strong>3&nbsp;min read</strong></small><p></div><p class="lead text-center">Service principal is representation of your tenant or directory on Azure.
On Azure Devops, service principal credentials can be accessed for deploying any components
It is possible to retrieve credentials from Azure Devops and use them on Github Actions.</p><h1 id=security>Security</h1><p>Given <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object>service principal</a> is eligible to manage your services and deployments.
Almost all the CI/CD services are coming with masking feature by default for these kinds of secret values.</p><p>By design of these CI agents, they are <code>stateless</code> and each build they need sort of environment variable to work as your service principal.
This comes with a lot of flexibility where you can extend your setup without caring about previous state.
Downside of this flexibility, every CI pipeline needs access to credentials where anyone can access them as well.</p><p>Your credential can be super safe inside the Azure world, in fact, they are not as long as someone has access to your CI pipeline.</p><h1 id=reading-credentials>Reading credentials</h1><p>For the sake of demonstration, I&rsquo;ve published an example repo on <a href=https://github.com/salimkayabasi/reading-service-principal-azure-devops>GitHub</a>.</p><h2 id=how-to>How to</h2><p>On your <code>Azure DevOps</code> pipeline, you need to grant the given pipeline to access <code>service principal</code> credentials by just enabling a single flag.</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#0087ff>addSpnToEnvironment</span>: <span style=color:#d75f00>true</span>
</code></pre></div><p>This flag will add service principal credentials as environment variables on your CI pipeline.
As shown <a href=https://github.com/salimkayabasi/reading-service-principal-azure-devops/blob/main/azure-pipeline.yml#L20>here</a>.</p><p>Next thing to do use reading values and <a href=https://github.com/salimkayabasi/reading-service-principal-azure-devops/blob/main/azure-pipeline.yml#L21-L26>printing them</a> in <code>hex</code> or <code>base64</code> format. This will help you to cheat <code>masking</code> behaviour.</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#0087ff>inlineScript</span>: |<span style=color:#00afaf>
</span><span style=color:#00afaf>  echo &#34;servicePrincipalId&#34;
</span><span style=color:#00afaf>  xxd -p &lt;&lt;&lt; $servicePrincipalId -c 256
</span><span style=color:#00afaf>  echo &#34;servicePrincipalKey&#34;
</span><span style=color:#00afaf>  xxd -p &lt;&lt;&lt; $servicePrincipalKey -c 256
</span><span style=color:#00afaf>  echo &#34;tenantId&#34;
</span><span style=color:#00afaf>  xxd -p &lt;&lt;&lt; $tenantId -c 256</span>  
</code></pre></div><p>Just a reminder, Azure DevOps pipelines will be using <code>ubuntu-latest</code> VM unless you change it.</p><figure class="figure w-100"><img src=./assets/azure-devops-logs.png class="w-100 figure-img img-fluid rounded"><figcaption class="figure-caption text-center">Actual values are masked for this image</figcaption></figure><h2 id=reading>Reading</h2><p>After retrieving values as <code>hex</code> strings from your Azure Devops, you need to convert them to actual values back.
It can be simply done with few lines of <code>Node.js</code> implementation.</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=color:#0087ff>const</span> convert = (from, to) =&gt; str =&gt; console.log(Buffer.from(str, from).toString(to));
<span style=color:#0087ff>const</span> hexToUtf8 = convert(<span style=color:#00afaf>&#39;hex&#39;</span>, <span style=color:#00afaf>&#39;utf8&#39;</span>);

console.log(<span style=color:#00afaf>&#39;servicePrincipalId&#39;</span>);
hexToUtf8(<span style=color:#00afaf>&#39;your servicePrincipalId goes here&#39;</span>);
console.log(<span style=color:#00afaf>&#39;servicePrincipalKey&#39;</span>);
hexToUtf8(<span style=color:#00afaf>&#39;your servicePrincipalKey goes here&#39;</span>);
console.log(<span style=color:#00afaf>&#39;tenantId&#39;</span>);
hexToUtf8(<span style=color:#00afaf>&#39;and tenantId here as well&#39;</span>);
</code></pre></div><h1 id=using-them-on-github-actions>Using them on Github Actions</h1><h2 id=adding-as-secret>Adding as Secret</h2><p>Let&rsquo;s create another secret for <code>Github Actions</code>. To do that, we need one more thing called <code>subscriptionId</code>.
The <code>subscriptionId</code> can be found on Azure Portal or simple <code>powershell</code> or <code>bash</code> command like</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-powershell data-lang=powershell><span style=color:#0087ff>Get-AzSubscription</span>

Name                 Id             TenantId State
----                 --             -------- -----
Name Of Subscription subscriptionId tenantId Enabled
</code></pre></div><p>Add new <code>Secret</code> as JSON format on your project or organisation on GitHub.</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#0087ff>&#34;clientId&#34;</span>: <span style=color:#00afaf>&#34;value of servicePrincipalId&#34;</span>,
  <span style=color:#0087ff>&#34;clientSecret&#34;</span>: <span style=color:#00afaf>&#34;value of servicePrincipalKey&#34;</span>,
  <span style=color:#0087ff>&#34;subscriptionId&#34;</span>: <span style=color:#00afaf>&#34;your subscriptionId&#34;</span>,
  <span style=color:#0087ff>&#34;tenantId&#34;</span>: <span style=color:#00afaf>&#34;value of tenantId&#34;</span>
}
</code></pre></div><figure class="figure w-100"><img src=./assets/github-secrets.png class="w-100 figure-img img-fluid rounded"></figure><h2 id=accessing-from-github-actions>Accessing from Github Actions</h2><p>On your github actions workflow file, you can try to log in with using given credentials. Full example can be found on <a href=https://github.com/salimkayabasi/reading-service-principal-azure-devops/blob/main/.github/workflows/azure.yml#L7-L12>GitHub repo</a> as well.</p><div class=highlight><pre style=color:#8a8a8a;background-color:#1c1c1c;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#0087ff>steps</span>:
  - <span style=color:#0087ff>uses</span>: actions/checkout@v2
  - <span style=color:#0087ff>uses</span>: azure/login@v1
    <span style=color:#0087ff>with</span>:
      <span style=color:#0087ff>creds</span>: ${{ secrets.AZURE_CREDENTIALS }}
  - <span style=color:#0087ff>run</span>: az group list
  - <span style=color:#0087ff>name</span>: Azure logout
    <span style=color:#0087ff>run</span>: az logout
</code></pre></div><figure class="figure w-100"><img src=./assets/github-actions-logs.png class="w-100 figure-img img-fluid rounded"><figcaption class="figure-caption text-center">Successfully logged in</figcaption></figure><h1 id=conclusion>Conclusion</h1><p>It is possible to retrieve credentials and use them in a different CI*. Level of trust is important in the company level.
In order to prevent these kinds of issues, you can rotate credentials, but then they can be retrieved again.</p><p>As I said, if any person who is granted to access your CI then s/he can do whatever they like.
The purpose of this article, I just wanted to highlight that these ways of protections are useless and technically possible to read secrets.
Same goes for <code>Github Actions</code> as well and there is no way to keep those secrets away from people who work for company.</p><p>If you didn&rsquo;t like Azure DevOps and still want to use <code>Github Actions</code>, it is not that hard to migrate your CI to wherever you want.</p><p><em>*By the way, Github Actions and Azure DevOps are using same virtual machines under the hood.</em></p><h5 id=credits>Credits</h5><ul><li><a href=https://pascalnaber.wordpress.com/2020/01/04/backdoor-in-azure-devops-to-get-the-password-of-a-service-principal/>Pascal Naber</a></li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Any questions or feedback,</br>please feel free to share them with me</br><a target=_blank href=https://twitter.com/salimkayabasi>@salimkayabasi</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-right"><ul class=list-inline></ul></div></div></div></footer><script src=/main.e327044936bd190e41aa4a6332a29a3dc6bac9e7262954d90eb737fbf2058a8c09b3c6b09d20631236c0ac8be88aae76341eed9c2bbe5a208e11ea35e5bbdf49.js integrity="sha512-4ycESTa9GQ5BqkpjMqKaPca6yecmKVTZDrc3+/IFiowJs8awnSBjEjbArIvoiq52NB7tnCu+WiCOEeo15bvfSQ==" crossorigin=anonymous defer></script><script src=/index.min.e254677d74327f3b419f687daf1547fcc1b967b0d3c2a3517c66018c1ed881ec7786f9fcafba83e7e8d90736d4883e3bff1fd38d5ee609430be6f6c387258b5d.js integrity="sha512-4lRnfXQyfztBn2h9rxVH/MG5Z7DTwqNRfGYBjB7Ygex3hvn8r7qD5+jZBzbUiD47/x/TjV7mCUML5vbDhyWLXQ==" crossorigin=anonymous defer></script></body></html>